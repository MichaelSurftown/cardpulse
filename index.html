<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CardPulse â€” PokÃ©mon Market Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card-bg: #111827;
      --accent: #38bdf8;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-subtle: #1f2937;
      --danger: #ef4444;
      --success: #22c55e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 20px;
      padding: 20px;
      background: radial-gradient(circle at top, #1f2937, #020617 60%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
    }
    h1 {
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 8px;
    }
    .cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      width: 100%;
      max-width: 1100px;
    }
    .card {
      flex: 1 1 320px;
      background: var(--card-bg);
      border-radius: 16px;
      padding: 18px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 10px 30px rgba(15,23,42,0.6);
    }
    .card h2 {
      margin: 0 0 8px;
      font-size: 16px;
      color: var(--accent);
    }
    .heat-score {
      font-size: 28px;
      font-weight: 700;
    }
    .heat-score.positive { color: var(--success); }
    .heat-score.negative { color: var(--danger); }
    .metric {
      font-size: 13px;
      margin-top: 4px;
      color: var(--text-muted);
    }
    footer {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>CardPulse PokÃ©mon Market Heat Dashboard</h1>
  <div class="cards">
    <div id="heat-1d" class="card"></div>
    <div id="heat-7d" class="card"></div>
    <div id="heat-30d" class="card"></div>
  </div>
  <footer>Data updates live via PokÃ©mon Price Tracker API â€” Powered by CardPulse</footer>

  <script>
    // ðŸ”‘ Your API connection
    const PROXY = "https://cardpulse-proxy.michael-e59.workers.dev/?url=";
    const API_BASE = PROXY + "https://www.pokemonpricetracker.com";
    const CARD_IDS = ["base1-4","base1-2","base1-15","surging-sparks-booster-box","celebrations-etb"];

    async function apiGet(path) {
      const res = await fetch(API_BASE + path);
      if (!res.ok) throw new Error("API error " + res.status);
      return res.json();
    }

    async function fetchCurrentPrice(cardId) {
      const data = await apiGet(`/api/prices?id=${encodeURIComponent(cardId)}`);
      const market = data?.prices?.tcgplayer?.market ?? data?.prices?.cardmarket?.trend ?? null;
      return { id: cardId, currentPrice: typeof market === "number" ? market : null };
    }

    async function fetchHistory(cardId, days = 30) {
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - days);
      const toISO = d => d.toISOString().slice(0,10);
      const path = `/api/cards/${encodeURIComponent(cardId)}/history?startDate=${toISO(start)}&endDate=${toISO(end)}`;
      try {
        const data = await apiGet(path);
        return data.history || data || [];
      } catch { return []; }
    }

    function extractMarket(e){return e?.tcgplayer?.market ?? e?.price ?? null;}

    async function getCardStats(id, days) {
      const current = await fetchCurrentPrice(id);
      const history = await fetchHistory(id, days);
      let oldPrice = null, latest = current.currentPrice;
      if (history.length > 1) {
        const first = extractMarket(history[0]);
        const last = extractMarket(history[history.length - 1]);
        oldPrice = typeof first === "number" ? first : null;
        if (typeof last === "number") latest = last;
      }
      let changePct = 0;
      if (oldPrice && latest) changePct = ((latest - oldPrice) / oldPrice) * 100;
      return { id, currentPrice: current.currentPrice, changePct };
    }

    function calcHeat(cards) {
      const valid = cards.filter(c => typeof c.changePct === "number" && !Number.isNaN(c.changePct));
      if (!valid.length) return {score:0,label:"Neutral",momentum:0,breadth:50};
      let total=0,up=0;
      valid.forEach(c=>{total+=c.changePct;if(c.changePct>0)up++;});
      const avg=total/valid.length, breadth=(up/valid.length)*100;
      const breadthScore=((breadth-50)/50)*100;
      const momentumScore=Math.min(Math.max(avg,-20),20)*5;
      const score=Math.round(0.5*breadthScore+0.5*momentumScore);
      let label="Neutral";
      if(score<=-40)label="Ice Cold";else if(score<=-10)label="Cool";
      else if(score<10)label="Neutral";else if(score<40)label="Warm";else label="On Fire";
      return {score,label,momentum:avg.toFixed(2),breadth:breadth.toFixed(2)};
    }

    function render(containerId, label, data){
      const el=document.getElementById(containerId);
      const cls=data.score>5?"heat-score positive":data.score<-5?"heat-score negative":"heat-score";
      el.innerHTML=`
        <h2>${label}</h2>
        <div class="${cls}">${data.score} â€” ${data.label}</div>
        <div class="metric">Avg Move: ${data.momentum>0?"+":""}${data.momentum}%</div>
        <div class="metric">Cards Trending Up: ${data.breadth}%</div>`;
    }

    async function buildDashboard(){
      try{
        const [stats1,stats7,stats30] = await Promise.all([
          Promise.all(CARD_IDS.map(id=>getCardStats(id,1))),
          Promise.all(CARD_IDS.map(id=>getCardStats(id,7))),
          Promise.all(CARD_IDS.map(id=>getCardStats(id,30)))
        ]);
        render("heat-1d","ðŸ”¥ 1-Day Heat Index",calcHeat(stats1));
        render("heat-7d","ðŸ“… 7-Day Heat Index",calcHeat(stats7));
        render("heat-30d","ðŸ“ˆ 30-Day Heat Index",calcHeat(stats30));
      }catch(e){
        document.body.innerHTML="<p style='color:#ef4444'>Failed to load market data.</p>";
        console.error(e);
      }
    }

    buildDashboard();
  </script>
</body>
</html>
